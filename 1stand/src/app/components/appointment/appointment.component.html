<div class="appointments-container">
  <div class="appointments-header">
    <div class="header-content">
      <div class="header-icon">ðŸ“…</div>
      <div class="header-text">
        <h1>GestiÃ³n de Citas MÃ©dicas</h1>
        <p>Programa y administra todas las citas de tu clÃ­nica</p>
      </div>
    </div>
  </div>

  <div class="form-section">
    <div class="form-header">
      <h2>Programar Nueva Cita</h2>
      <div class="availability-indicator">
        <small *ngIf="appointmentForm.valid && availableTurns.length > 0" class="text-success">
          âœ“ Formulario completo y turnos disponibles
        </small>
        <small *ngIf="!appointmentForm.valid || availableTurns.length === 0" class="text-muted">
          Complete todos los campos para ver turnos disponibles
        </small>
      </div>
    </div>

    <div *ngIf="successMessage" class="alert alert-success">
      {{ successMessage }}
    </div>

    <div *ngIf="errorMessage" class="alert alert-danger">
      {{ errorMessage }}
    </div>

    <form [formGroup]="appointmentForm" (ngSubmit)="onSubmit()">
      <div class="form-group">
        <label for="patient_id">Paciente</label>
        <select
          id="patient_id"
          formControlName="patient_id"
          class="form-control"
          (change)="onPatientSelect($event)"
        >
          <option value="">Seleccione un paciente</option>
          <option *ngFor="let patient of patients" [value]="patient.id">{{ patient.name }}</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="doctor">Doctor</label>
        <select
          id="doctor_id"
          formControlName="doctor_id"
          class="form-control"
          (change)="onDoctorOrDateChange()"
        >
          <option value="">Seleccione un doctor</option>
          <option *ngFor="let doctor of doctors" [value]="doctor.id">{{ doctor.name }} - {{ doctor.specialty }}</option>
        </select>
      </div>

      <div class="form-group">
        <label for="date">Fecha</label>
        <input
          type="date"
          id="date"
          formControlName="date"
          class="form-control"
          [min]="getTodayDateString()"
          (change)="onDoctorOrDateChange()"
        >
        <div class="invalid-feedback" *ngIf="appointmentForm.get('date')?.invalid && appointmentForm.get('date')?.touched">
          <span *ngIf="appointmentForm.get('date')?.errors?.['required']">La fecha es obligatoria</span>
          <span *ngIf="appointmentForm.get('date')?.errors?.['dateInPast']">No se puede programar citas en fechas pasadas</span>
        </div>
      </div>

      <div class="form-group">
        <label for="turn">Turno</label>
        <select
          id="turn"
          formControlName="turn"
          class="form-control"
        >
          <option value="">Seleccione un turno</option>
          <option *ngFor="let availableTurn of availableTurns; let i = index" [value]="availableTurn.time" [disabled]="!availableTurn.available">
            {{ availableTurn.formatted_time }} {{ availableTurn.available ? '(Disponible)' : '(Ocupado)' }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="reason">Motivo de la Cita</label>
        <textarea
          id="reason"
          formControlName="reason"
          class="form-control"
          placeholder="Describa el motivo de la cita"
        ></textarea>
      </div>

      <button type="submit" [disabled]="!appointmentForm.valid || isLoading">
        {{ isLoading ? 'Programando...' : 'Programar Cita' }}
      </button>
    </form>
  </div>
  <!-- Calendar Section -->
  <div class="calendar-section">
    <div class="section-header">
      <h2>Calendario de Citas</h2>
      <div class="calendar-stats">
        <span class="stat-item">
          <i class="icon-calendar"></i>
          {{ appointments.length }} citas programadas
        </span>
        <span class="stat-item">
          <i class="icon-today"></i>
          Hoy: {{ getTodaysAppointmentCount() }} citas
        </span>
      </div>
    </div>
    <div class="calendar-container">
      <full-calendar [options]="calendarOptions"></full-calendar>
    </div>
  </div>

  <div class="appointments-list-section">
    <div class="list-header">
      <h2>Citas Programadas</h2>
      <div class="filter-buttons">
        <button class="filter-btn active" (click)="filterAppointments('all')">
          Todas ({{ appointments.length }})
        </button>
        <button class="filter-btn" (click)="filterAppointments('today')">
          Hoy ({{ getTodaysAppointmentCount() }})
        </button>
        <button class="filter-btn" (click)="filterAppointments('pending')">
          Pendientes ({{ getPendingAppointmentsCount() }})
        </button>
      </div>
    </div>
    <div class="appointment-card" *ngFor="let appointment of appointments; let i = index">
      <div class="appointment-details">
        <h3>{{ appointment.patient_name }}</h3>
        <p><strong>Doctor:</strong> {{ appointment.doctor?.name || appointment.doctor_name || 'Sin doctor' }}{{ (appointment.doctor?.specialty || appointment.doctor_specialty) ? ' - ' + (appointment.doctor?.specialty || appointment.doctor_specialty) : '' }}</p>
        <p><strong>Fecha:</strong> {{ appointment.date }}</p>
        <p><strong>Hora:</strong> {{ appointment.time }}</p>
        <p><strong>Motivo:</strong> {{ appointment.reason }}</p>
        
        <p>
          <strong>Estado de Pago: </strong>
          <span 
            [ngClass]="{
              'status-paid': appointment.payment_status === 'Pagado', 
              'status-pending': appointment.payment_status === 'Pendiente', 
              'status-canceled': appointment.payment_status === 'Cancelado'
            }"
            class="payment-status"
          >
            {{ appointment.payment_status }}
          </span>
        </p>
        <p>
          <strong>Estado de AtenciÃ³n: </strong>
          <span [ngClass]="getAttentionStatusClass(appointment)">
            {{ getAttentionStatusLabel(appointment) }}
          </span>
        </p>

      </div>
      <div class="appointment-actions">
        <button class="delete-btn" (click)="deleteAppointment(appointment.id)">Cancelar Cita</button>
        <button (click)="togglePaymentStatus(appointment)">Cambiar Estado de Pago</button>
      </div>
    </div>
  </div>
</div>
