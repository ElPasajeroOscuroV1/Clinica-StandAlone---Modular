<button class="btn btn-outline-secondary mb-3" (click)="exportToPDF()">Exportar a PDF</button>

<div class="payment-container">
  <h2>Control de Pagos</h2>

  <div class="payment-form">
    <h3>Registrar/Editar Pago</h3>

    <form [formGroup]="paymentForm" (ngSubmit)="onSubmit()">
      
      <!-- Paciente -->
      <label for="patient" class="form-label">Paciente</label>
      <select id="patient" formControlName="patient_id" class="form-control" required>
        <option value="">Seleccione un paciente</option>
        <option *ngFor="let patient of patients" [value]="patient.id">
          {{ patient.id }} - {{ patient.name }}
        </option>
      </select>
      <div class="text-danger mt-1" *ngIf="paymentForm.get('patient_id')?.invalid && paymentForm.get('patient_id')?.touched">
        Seleccione un paciente.
      </div>

      <!-- Cita -->
      <label for="appointment" class="form-label mt-3">Cita</label>
      <select id="appointment" formControlName="appointment_id" class="form-control" required>
        <option value="">Seleccione una cita</option>
        <option *ngFor="let appointment of appointments" [value]="appointment.id">
          {{ appointment.id }} - {{ appointment.date }} - {{ appointment.doctor_name }}
        </option>
      </select>
      <div class="text-danger mt-1" *ngIf="paymentForm.get('appointment_id')?.invalid && paymentForm.get('appointment_id')?.touched">
        Seleccione una cita.
      </div>

      <!-- Tratamientos médicos aplicados -->
      <div class="form-group mt-3">
        <label>Tratamientos aplicados</label>
        <div *ngIf="attentionTreatments.length > 0" class="bg-light p-2 rounded">
          <ul class="mb-0">
            <li *ngFor="let treatment of attentionTreatments">
              {{ treatment.nombre }}
              <ng-container *ngIf="treatment.tiene_descuento; else precioNormal">
                <s class="text-muted">{{ treatment.precio }} BS</s>
                <span class="fw-bold text-success">{{ treatment.precio_con_descuento ?? treatment.precio }} BS</span>
                <small class="badge bg-success ms-1">Ahorro: {{ treatment.ahorro ?? 0 }} BS</small>
              </ng-container>
              <ng-template #precioNormal>{{ treatment.precio }} BS</ng-template>
            </li>
          </ul>
        </div>
      </div>

      <!-- Otros Tratamientos aplicados -->
      <div class="form-group mt-3">
        <label>Otros Tratamientos aplicados</label>
        <div *ngIf="otherTreatments.length > 0" class="bg-light p-2 rounded">
          <ul class="mb-0">
            <li *ngFor="let other of otherTreatments">{{ other.name }} - {{ other.price }} BS</li>
          </ul>
        </div>
        <div *ngIf="attentionTreatments.length === 0 && otherTreatments.length === 0" class="text-muted">
          Ningún tratamiento aplicado en esta cita.
        </div>
      </div>

      <div class="mt-3" *ngIf="selectedAttentionTotal !== null">
        <h5>Costo total de la atención (con descuentos aplicados)</h5>
        <p>{{ selectedAttentionTotal | currency:'USD' }}</p>
      </div>

      <!-- Monto 
      <label for="amount" class="form-label mt-3">Monto</label>
      <input id="amount" type="number" formControlName="amount" class="form-control" required />
      <div class="text-danger mt-1" *ngIf="paymentForm.get('amount')?.invalid && paymentForm.get('amount')?.touched">
        El monto es obligatorio.
      </div>-->

      <div>
        <label for="amount">Monto</label>
        <input id="amount" type="number" formControlName="amount" readonly />
      </div>

      <!-- Fecha de pago -->
      <label for="date" class="form-label mt-3">Fecha de pago</label>
      <input id="date" type="date" formControlName="date" class="form-control" required />
      <div class="text-danger mt-1" *ngIf="paymentForm.get('date')?.invalid && paymentForm.get('date')?.touched">
        La fecha de pago es obligatoria.
      </div>

      <!-- MÃ©todo -->
      <label for="method" class="form-label mt-3">MÃ©todo</label>
      <select id="method" formControlName="method" class="form-control" required>
        <option value="Efectivo">Efectivo</option>
        <option value="Tarjeta">Tarjeta</option>
        <option value="Transferencia">Transferencia</option>
      </select>



      <!-- BotÃ³n -->
      <button type="submit" [disabled]="paymentForm.invalid" class="btn btn-success mt-3">
        {{ editingPaymentId ? 'Actualizar Pago' : 'Registrar Pago' }}
      </button>
    </form>
  </div>
</div>

<div class="container mt-4" style="max-width: 1200px;">
  <h3 class="titulo-centrado">Lista de Pagos</h3>

  <table class="table table-striped table-hover align-middle">
    <thead>
      <tr>
        <th>Paciente</th>
        <th>Fecha de Cita</th>
        <th>Tratamientos</th>
        <th>Otros Tratamientos</th>
        <th>Fecha de Pago</th>
        <th>Monto</th>
        <th>MÃ©todo</th>
        <th style="width: 150px;">Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let payment of payments">
        <td>{{ payment.patient?.name }}</td>
        <td>{{ payment.appointment?.date | date:'shortDate' }}</td>
        <td>
          <ng-container *ngIf="payment.treatments && payment.treatments.length > 0; else noTreatments">
            <ul style="margin: 0; padding-left: 16px;">
              <li *ngFor="let t of payment.treatments">
                {{ t.nombre }}
                <ng-container *ngIf="t.tiene_descuento; else precioNormal">
                  <s class="text-muted">{{ t.precio }} BS</s>
                  <span class="fw-bold text-success">{{ t.precio_con_descuento ?? t.precio }} BS</span>
                  <small class="badge bg-success ms-1">Ahorro: {{ t.ahorro ?? 0 }} BS</small>
                </ng-container>
                <ng-template #precioNormal>{{ t.precio }} BS</ng-template>
              </li>
            </ul>
          </ng-container>
          <ng-template #noTreatments>Sin tratamientos</ng-template>
        </td>
        <td>
          <ng-container *ngIf="payment.other_treatments && payment.other_treatments.length > 0; else noOtros">
            <ul style="margin: 0; padding-left: 16px;">
              <li *ngFor="let ot of payment.other_treatments">
                {{ ot.name }} ({{ ot.price }} BS)
              </li>
            </ul>
          </ng-container>
          <ng-template #noOtros>Sin otros tratamientos</ng-template>
        </td>
        <td [ngClass]="getPagoClass(payment)">{{ payment.date | date:'shortDate' }}</td>
        <td>{{ payment.amount | currency:'USD' }}</td>
        <td>{{ payment.method }}</td>
        <td>
          <!--<button class="btn btn-primary btn-sm me-2" (click)="editPayment(payment)">Editar</button>-->
          <button class="btn btn-danger btn-sm" (click)="deletePayment(payment.id)">Eliminar</button>
          <button class="btn btn-outline-primary btn-sm me-2" (click)="exportComprobante(payment)">Comprobante PDF</button>

        </td>
      </tr>
    </tbody>
  </table>
</div>
