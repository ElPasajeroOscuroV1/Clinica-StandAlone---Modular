<form [formGroup]="medicalHistoryForm" (ngSubmit)="saveMedicalHistory()">

<div id="modalContent" class="p-3" style="font-family: Arial, sans-serif; color: #333;">

  <!-- Cabecera -->
  <div class="modal-header" style="border-bottom: 2px solid #0d6efd;">
    <h4 class="modal-title">Historial Clínico del Paciente: {{ patientData?.name }}</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="closeModal()"></button>
  </div>

  <!-- Selección de historial -->
  <div class="mb-3 mt-2">
    <label for="historySelect" class="form-label"><strong>Seleccionar versión del historial:</strong></label>
    <div class="d-flex gap-2">
      <select id="historySelect" class="form-select" (change)="onHistoryChange($event)">
        <option [selected]="!selectedHistory" value="new">➕ Nueva versión</option>
      <option *ngFor="let h of (patientHistories || [])" [value]="h.id" [selected]="h.id === selectedHistory?.id">
        {{ h.created_at | date:'short' }} - {{ h.consultation_reason }}
      </option>
      </select>
      <button type="button" class="btn btn-outline-primary" (click)="startNewVersion()">Nueva versión</button>
    </div>
  </div>


  <!-- Cuerpo -->
  <div class="modal-body border p-3 rounded" style="background-color: #f8f9fa;">
    <!-- Resumen de la versión seleccionada -->
    <div class="mb-3" *ngIf="selectedHistory">
      <h5 style="color:#0d6efd; border-bottom:1px solid #0d6efd;">Resumen de la versión seleccionada</h5>
      <div class="row">
        <div class="col-md-4"><small class="text-muted">Fecha:</small> {{ selectedHistory.created_at | date:'dd/MM/yyyy HH:mm' }}</div>
        <div class="col-md-8"><small class="text-muted">Motivo:</small> {{ selectedHistory.consultation_reason }}</div>
      </div>
      <div class="row mt-2">
        <div class="col-md-6"><small class="text-muted">Alergias:</small> {{ selectedHistory.allergies || '-' }}</div>
        <div class="col-md-6"><small class="text-muted">Medicamentos actuales:</small> {{ selectedHistory.current_medications || '-' }}</div>
      </div>
    </div>

    <!-- Datos personales -->
    <h5 style="color:#0d6efd; border-bottom:1px solid #0d6efd;">Datos Personales</h5>
    <div class="row mb-3">
      <div class="col-md-4">
        <p><strong>Nombre:</strong> {{ patientData?.name }}</p>
      </div>
      <div class="col-md-4">
        <p><strong>Email:</strong> {{ patientData?.email }}</p>
      </div>
      <div class="col-md-4">
        <p><strong>CI:</strong> {{ patientData?.ci }}</p>
      </div>
    </div>

    <!-- Antecedentes -->
    <h5 style="color:#0d6efd; border-bottom:1px solid #0d6efd;">Antecedentes</h5>
    <div class="mb-2">
      <label><strong>Médicos:</strong></label>
      <textarea class="form-control" formControlName="medicalBackground"></textarea>
    </div>
    <div class="mb-2">
      <label><strong>Odontológicos:</strong></label>
      <textarea class="form-control" formControlName="dentalBackground"></textarea>
    </div>


    <!-- Motivo de consulta -->
    <h5 style="color:#0d6efd; border-bottom:1px solid #0d6efd;">Motivo de la Consulta</h5>
    <input type="text" class="form-control" formControlName="consultationReason" />


    <!-- Exámenes clínicos -->
    <h5 style="color:#0d6efd; border-bottom:1px solid #0d6efd;">Resultados de Exámenes Clínicos</h5>
    <div class="mb-2">
      <label><strong>Extraoral:</strong></label>
      <textarea class="form-control" formControlName="extraoralExam"></textarea>
    </div>
    <div class="mb-2">
      <label><strong>Intraoral:</strong></label>
      <textarea class="form-control" formControlName="intraoralExam"></textarea>
    </div>


    <!-- Odontograma -->
    <h5 style="color:#0d6efd; border-bottom:1px solid #0d6efd;">Odontograma</h5>
    <div class="odontogram-placeholder border p-3 mb-3 text-center text-muted">
      <p>Aquí se visualizará el odontograma.</p>
    </div>

    <!-- Información adicional -->
    <h5 style="color:#0d6efd; border-bottom:1px solid #0d6efd;">Información Adicional</h5>
    <div class="mb-2">
      <label><strong>Tratamientos Realizados:</strong></label>
      <textarea class="form-control" formControlName="treatmentsPerformed"></textarea>
    </div>
    <div class="mb-2">
      <label><strong>Medicamentos Actuales:</strong></label>
      <textarea class="form-control" formControlName="currentMedications"></textarea>
    </div>
    <div class="mb-2">
      <label><strong>Alergias:</strong></label>
      <textarea class="form-control" formControlName="allergies"></textarea>
    </div>
    <div class="mb-2">
      <label><strong>Hábitos Bucales Relevantes:</strong></label>
      <textarea class="form-control" formControlName="relevantOralHabits"></textarea>
    </div>


  </div>
</div>

<!-- Footer -->
<div class="modal-footer">
  <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancelar</button>
  <button class="btn btn-success" (click)="exportModalToPDF()">Exportar a PDF</button>
  <button type="submit" class="btn btn-primary" [disabled]="medicalHistoryForm.invalid || loadingHistory">
    <span *ngIf="loadingHistory" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
    {{ loadingHistory ? 'Guardando...' : 'Guardar Historial' }}
  </button>
</div>
</form>

