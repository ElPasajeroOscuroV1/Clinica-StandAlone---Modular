<div class="medical-attention-container">
  <div class="medical-attention-header">
    <div class="header-content">
      <div class="header-icon">üè•</div>
      <div class="header-text">
        <h1>Atenciones M√©dicas</h1>
        <p>Gesti√≥n completa de consultas y tratamientos m√©dicos</p>
      </div>
    </div>
  </div>

  <div class="form-section">
    <div class="form-header">
      <h2>{{ editingAttention ? 'Editar Atenci√≥n M√©dica' : 'Registrar Nueva Atenci√≥n' }}</h2>
      <div class="form-status" *ngIf="form.valid && form.value.patient_id">
        <small class="text-success">‚úì Formulario completo y listo para guardar</small>
      </div>
    </div>

    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="attention-form">
      <!-- Patient and Appointment Selection -->
      <div class="form-row">
        <div class="form-group">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>
              <i class="icon-user"></i> Paciente
            </mat-label>
            <mat-select formControlName="patient_id" (selectionChange)="onPatientChange()">
              <mat-option *ngFor="let patient of patients" [value]="patient.id">
                <div class="option-content">
                  <span class="patient-name">{{ patient.name }}</span>
                  <small class="patient-ci">CI: {{ patient.ci }}</small>
                </div>
              </mat-option>
            </mat-select>
            <mat-hint>Seleccione el paciente para la atenci√≥n m√©dica</mat-hint>
          </mat-form-field>
        </div>

        <div class="form-group">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>
              <i class="icon-calendar"></i> Cita M√©dica
            </mat-label>
            <mat-select formControlName="appointment_id">
              <mat-option *ngFor="let app of appointments" [value]="app.id">
                <div class="option-content">
                  <div class="appointment-primary">
                    <span class="appointment-date">{{ app.date | date:'dd/MM/yyyy' }}</span>
                    <span class="appointment-time">{{ app.time }}</span>
                  </div>
                  <small class="appointment-doctor">{{ getDoctorNameByAppointment(app) }}</small>
                  <small class="appointment-reason">{{ app.reason }}</small>
                </div>
              </mat-option>
            </mat-select>
            <mat-hint>Seleccione la cita programada</mat-hint>
          </mat-form-field>

          <!-- Appointment Status Badge -->
          <ng-container *ngIf="getAppointmentStatus(form.value.appointment_id) as appointmentStatus">
            <div class="status-indicator">
              <span [ngClass]="getAppointmentStatusClassFromValue(appointmentStatus)">
                <i class="status-icon" [ngClass]="appointmentStatus.toLowerCase()"></i>
                {{ getAppointmentStatusLabelFromValue(appointmentStatus) }}
              </span>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- Medical History Button -->
      <div class="history-access-section" *ngIf="form.value.patient_id && form.value.appointment_id">
        <div class="history-access-card">
          <div class="history-info">
            <i class="icon-history"></i>
            <div class="history-text">
              <strong>Historia Cl√≠nica</strong>
              <small>Acceder a registros m√©dicos del paciente</small>
            </div>
          </div>
          <button
            mat-raised-button
            color="primary"
            class="history-btn"
            (click)="openMedicalHistoryModal(form.value.patient_id, form.value.appointment_id, editingAttention ? editingAttention : form.value)">
            <mat-icon>visibility</mat-icon>
            Ver/Editar Historia
          </button>
        </div>
      </div>

      <!-- Diagnosis Section -->
      <div class="diagnosis-section">
        <h4><i class="icon-diagnosis"></i> Informaci√≥n M√©dica</h4>

        <div class="form-row">
          <div class="form-group full-width">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>
                <i class="icon-stethoscope"></i> Diagn√≥stico M√©dico
              </mat-label>
              <textarea matInput formControlName="diagnosis"
                       placeholder="Describa detalladamente el diagn√≥stico m√©dico..."
                       rows="3"></textarea>
              <mat-hint>Diagn√≥stico profesional basado en la evaluaci√≥n m√©dica</mat-hint>
            </mat-form-field>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>
                <i class="icon-notes"></i> Preinscripci√≥n / Notas
              </mat-label>
              <textarea matInput formControlName="preEnrollment"
                       placeholder="Informaci√≥n adicional, observaciones, recomendaciones..."
                       rows="2"></textarea>
              <mat-hint>Notas importantes sobre la atenci√≥n m√©dica</mat-hint>
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- Treatments Section -->
      <div class="treatments-section">
        <h4><i class="icon-treatment"></i> Tratamientos Aplicados</h4>

        <div class="treatments-grid">
          <!-- Medical Treatments -->
          <div class="treatment-category">
            <h5>Tratamientos M√©dicos</h5>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Seleccionar tratamientos realizados</mat-label>
              <mat-select formControlName="treatment_ids" multiple>
                <mat-option *ngFor="let treat of treatments" [value]="treat.id">
                  <div class="treatment-option">
                    <div class="treatment-info">
                      <span class="treatment-name">{{ treat.nombre }}</span>
                      <small class="treatment-duration">{{ treat.duracion }} min</small>
                    </div>
                    <div class="treatment-pricing">
                      <ng-container *ngIf="treat.tiene_descuento; else normalPricing">
                        <div class="pricing-discount">
                          <span class="original-price">{{ treat.precio | currency:'USD':'symbol':'1.2-2' }}</span>
                          <span class="discounted-price">{{ getTreatmentPrecioFinal(treat) | currency:'USD':'symbol':'1.2-2' }}</span>
                          <span class="savings-badge">Ahorro: {{ treat.ahorro | currency:'USD':'symbol':'1.2-2' }}</span>
                        </div>
                      </ng-container>
                      <ng-template #normalPricing>
                        <span class="normal-price">{{ treat.precio | currency:'USD':'symbol':'1.2-2' }}</span>
                      </ng-template>
                    </div>
                  </div>
                </mat-option>
              </mat-select>
              <mat-hint>Seleccione uno o m√°s tratamientos aplicados</mat-hint>
            </mat-form-field>
          </div>

          <!-- Other Treatments -->
          <div class="treatment-category">
            <h5>Otros Servicios</h5>
            <div formArrayName="otherTreatments" class="other-treatments-list">
              <div *ngFor="let ot of otherTreatmentsFormArray.controls; let i = index" [formGroupName]="i" class="other-treatment-item">
                <div class="treatment-inputs">
                  <mat-form-field appearance="outline">
                    <mat-label>Nombre del servicio</mat-label>
                    <input matInput formControlName="name" placeholder="Ej: Radiograf√≠a, An√°lisis">
                  </mat-form-field>
                  <mat-form-field appearance="outline">
                    <mat-label>Precio</mat-label>
                    <input matInput type="number" formControlName="price" step="0.01" placeholder="0.00">
                    <span matSuffix>BS</span>
                  </mat-form-field>
                </div>
                <button mat-icon-button color="warn" type="button" (click)="removeOtherTreatment(i)" matTooltip="Eliminar servicio">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>

            <div class="add-treatment-section">
              <button mat-stroked-button color="accent" type="button" (click)="addOtherTreatment()" class="add-treatment-btn">
                <mat-icon>add</mat-icon>
                Agregar Servicio Adicional
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="submit" mat-raised-button color="primary" [disabled]="form.invalid" class="submit-btn">
          <mat-icon>{{ editingAttention ? 'update' : 'save' }}</mat-icon>
          {{ editingAttention ? 'Actualizar Atenci√≥n' : 'Guardar Atenci√≥n' }}
        </button>
        <button type="button" mat-raised-button color="warn" (click)="resetForm()" *ngIf="editingAttention" class="cancel-btn">
          <mat-icon>cancel</mat-icon>
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Medical Attentions List Section -->
<div class="medical-attentions-list-section">
  <div class="list-header">
    <h3>Historial de Atenciones M√©dicas</h3>
    <div class="list-stats">
      <span class="stat-item">
        <i class="icon-attentions-count"></i>
        {{ medicalAttentions.length }} atenciones registradas
      </span>
      <span class="stat-item" *ngIf="hasRevenue">
        <i class="icon-total-revenue"></i>
        Total: {{ totalRevenue | currency:'USD':'symbol':'1.2-2' }}
      </span>
    </div>
  </div>

  <div class="table-responsive">
    <table class="medical-attentions-table" *ngIf="medicalAttentions.length > 0; else noAttentions">
      <thead>
        <tr>
          <th><i class="icon-id"></i> ID</th>
          <th><i class="icon-user"></i> Paciente</th>
          <th><i class="icon-calendar"></i> Cita</th>
          <th><i class="icon-doctor"></i> Doctor</th>
          <th><i class="icon-diagnosis"></i> Diagn√≥stico</th>
          <th><i class="icon-treatment"></i> Tratamientos</th>
          <th><i class="icon-money"></i> Costo Total</th>
          <th><i class="icon-status"></i> Estado</th>
          <th><i class="icon-actions"></i> Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let attention of medicalAttentions; let i = index" [class.even-row]="i % 2 === 0">
          <td class="id-cell">{{ attention.id }}</td>

          <td class="patient-cell">
            <div class="patient-info">
              <strong>{{ getPatientName(attention.patient_id) }}</strong>
              <small class="patient-id">ID: {{ attention.patient_id }}</small>
            </div>
          </td>

          <td class="appointment-cell">
            <div class="appointment-info">
              <span class="appointment-date">{{ getAppointmentDate(attention.appointment_id) }}</span>
            </div>
          </td>

          <td class="doctor-cell">
            <span class="doctor-name">{{ getDoctorName(attention) }}</span>
          </td>

          <td class="diagnosis-cell">
            <div class="diagnosis-content">
              <span class="diagnosis-text" [title]="attention.diagnosis">
                {{ attention.diagnosis || 'Sin diagn√≥stico registrado' }}
              </span>
              <div class="pre-enrollment" *ngIf="attention.preEnrollment">
                <small class="pre-enrollment-label">Preinscripci√≥n:</small>
                <span class="pre-enrollment-text" [title]="attention.preEnrollment">
                  {{ attention.preEnrollment }}
                </span>
              </div>
            </div>
          </td>

          <td class="treatments-cell">
            <div class="treatments-summary">
              <!-- Medical Treatments -->
              <div class="treatment-group" *ngIf="attention.treatments && attention.treatments.length > 0">
                <div class="treatment-item" *ngFor="let t of attention.treatments">
                  <span class="treatment-name">{{ t.nombre }}</span>
                  <div class="treatment-pricing">
                    <ng-container *ngIf="t.tiene_descuento; else normalPricing">
                      <span class="original-price">{{ t.precio | currency:'USD':'symbol':'1.2-2' }}</span>
                      <span class="discounted-price">{{ t.precio_con_descuento ?? t.precio | currency:'USD':'symbol':'1.2-2' }}</span>
                      <span class="savings-tag">Ahorro: {{ t.ahorro ?? 0 | currency:'USD':'symbol':'1.2-2' }}</span>
                    </ng-container>
                    <ng-template #normalPricing>
                      <span class="normal-price">{{ t.precio | currency:'USD':'symbol':'1.2-2' }}</span>
                    </ng-template>
                  </div>
                </div>
              </div>

              <!-- Other Treatments -->
              <div class="other-treatments-group" *ngIf="attention.otherTreatments && attention.otherTreatments.length > 0">
                <div class="other-treatment-item" *ngFor="let ot of attention.otherTreatments">
                  <span class="treatment-name">{{ ot.name }}</span>
                  <span class="treatment-price">{{ ot.price | currency:'USD':'symbol':'1.2-2' }}</span>
                </div>
              </div>

              <!-- No treatments message -->
              <span class="no-treatments" *ngIf="(!attention.treatments || attention.treatments.length === 0) && (!attention.otherTreatments || attention.otherTreatments.length === 0)">
                Sin tratamientos registrados
              </span>
            </div>
          </td>

          <td class="cost-cell">
            <div class="total-cost">
              <span class="cost-amount">{{ attention.total_cost || 0 | currency:'USD':'symbol':'1.2-2' }}</span>
            </div>
          </td>

          <td class="status-cell">
            <span [ngClass]="getAppointmentStatusClassFromValue(getAppointmentStatus(attention.appointment_id))">
              <i class="status-icon" [ngClass]="(getAppointmentStatus(attention.appointment_id) || 'pending').toLowerCase()"></i>
              {{ getAppointmentStatusLabelFromValue(getAppointmentStatus(attention.appointment_id)) }}
            </span>
          </td>

          <td class="actions-cell">
            <div class="action-buttons">
              <button class="btn btn-primary btn-sm" (click)="editAttention(attention)" title="Editar atenci√≥n m√©dica">
                <i class="icon-edit"></i> Editar
              </button>
              <button class="btn btn-danger btn-sm" (click)="deleteAttention(attention.id)" title="Eliminar atenci√≥n m√©dica">
                <i class="icon-delete"></i> Eliminar
              </button>
              <button class="btn btn-outline-primary btn-sm" (click)="openMedicalHistoryModal(attention.patient_id, attention.appointment_id, attention)" title="Ver/editar historia m√©dica">
                <i class="icon-history"></i> Historia
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Empty State -->
    <ng-template #noAttentions>
      <div class="empty-state">
        <div class="empty-icon">üè•</div>
        <h3>No hay atenciones m√©dicas registradas</h3>
        <p>A√∫n no se han registrado atenciones m√©dicas en el sistema.</p>
        <div class="empty-actions">
          <small>Las atenciones se registran despu√©s de completar las citas m√©dicas.</small>
        </div>
      </div>
    </ng-template>
  </div>
</div>
